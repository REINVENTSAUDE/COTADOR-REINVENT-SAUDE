<!DOCTYPE html>
<html lang="pt-BR">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WRRZ5R5EXZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-WRRZ5R5EXZ');
  </script>

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>REINVENT SAÚDE - COTADOR</title>

<style>
  :root{
    --azul:#005baa;
    --bg:#f5f7fb;
    --verde:#28a745;
    --borda:#d9d9d9;
    --texto:#111;
    --vermelho:#c62828;

    /* chips */
    --chip-borda: rgba(0,91,170,0.35);
    --chip-shadow: 0 6px 14px rgba(0,0,0,0.06);
  }

  body{
    font-family: Arial, sans-serif;
    background:var(--bg);
    margin:0;
    padding:12px;
  }

  .container{
    max-width:900px;
    margin:auto;
    background:#fff;
    border-radius:12px;
    padding:15px;
    box-shadow:0 0 10px rgba(0,0,0,0.08);
  }

  .titulo{
    text-align:center;
    color:var(--azul);
    margin:6px 0 2px;
    font-size:18px;
    font-weight:800;
    letter-spacing:.2px;
  }

  .subtitulo{
    text-align:center;
    color:#3a3a3a;
    margin:0 0 14px;
    font-size:14px;
    font-weight:700;
  }

  /* ===== Toast ===== */
  .toast{
    position:fixed;
    left:50%;
    top:16px;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    padding:10px 12px;
    border-radius:10px;
    font-size:13px;
    font-weight:800;
    box-shadow:0 8px 20px rgba(0,0,0,.22);
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
    z-index:9999;
  }
  .toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(4px);
  }

  /* =========================================================
     ✅ LAYOUT: BOTÕES “CHIP”
     ========================================================= */
  .planos{
    display:grid;
    gap:16px;
  }

  .grupo-plano{
    display:grid;
    grid-template-columns: 1.7fr auto;
    gap:14px;
    align-items:center;
  }

  .tipo, .opcao{
    border:2px solid var(--chip-borda);
    border-radius:999px;
    background:#fff;
    color:var(--azul);
    font-weight:900;
    cursor:pointer;
    user-select:none;
    box-shadow: var(--chip-shadow);
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease, opacity .12s ease;
  }

  .tipo{
    padding:10px 14px;
    font-size:14px;
    text-align:left;
    line-height:1.05;
    display:flex;
    align-items:center;
    justify-content:flex-start;
    min-height:40px;
  }
  .tipo small{
    font-size:14px;
    display:block;
    font-weight:900;
    opacity:.95;
  }

  .opcoes{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:flex-end;
  }

  .opcao{
    padding:10px 14px;
    font-size:13px;
    min-height:40px;
    min-width:92px;
  }

  .tipo:hover, .opcao:hover{
    transform: translateY(-1px);
    box-shadow: 0 10px 18px rgba(0,0,0,0.10);
  }

  .ativo{
    background:var(--azul) !important;
    color:#fff !important;
    border-color: var(--azul) !important;
    box-shadow:0 10px 18px rgba(0,91,170,0.28) !important;
    transform: translateY(-1px);
  }

  .opcao.disabled{
    opacity:0.35;
    cursor:not-allowed;
    transform:none !important;
    box-shadow:none !important;
    background:#f2f4f7;
    border-color:#ddd;
    color:#999;
  }

  /* ===== Entrada ===== */
  .idades{ margin-top:12px; }

  #idades{
    width:100%;
    height:40px;
    padding:8px 10px;
    border:2px solid var(--borda);
    border-radius:10px;
    box-sizing:border-box;
    resize:none;
    font-size:16px; /* iOS no-zoom */
  }
  #idades:disabled{
    background:#f4f5f7;
    color:#888;
  }

  .linha-opcoes{
    margin-top:10px;
    display:flex;
    gap:14px;
    flex-wrap:wrap;
    align-items:center;
    font-size:14px;
  }

  .opt-label{
    display:flex;
    align-items:center;
    gap:8px;
    font-weight:800;
    color:#333;
  }

  .calcular{
    width:100%;
    margin-top:12px;
    padding:12px;
    background:var(--azul);
    color:#fff;
    border:none;
    border-radius:10px;
    font-size:16px;
    font-weight:900;
    cursor:pointer;
    transition:opacity .15s ease;
  }
  .calcular:hover{ opacity:0.92; }

  /* ===== Resultado ===== */
  #resultado{ display:none; margin-top:16px; }

  #areaImagem{
    border:1px solid #eee;
    border-radius:12px;
    padding:14px;
    background:#fff;
    overflow: visible;
  }

  .logos{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:14px;
    margin-bottom:8px;
  }

  .logo-wrap{
    height:76px;
    width:50%;
    overflow:visible;
    display:flex;
    align-items:center;
    justify-content:flex-start;
  }

  .logo{
    width:76%;
    height:auto;
    max-width:100%;
    display:block;
    object-fit:contain;
  }

  .logo.reinvent{
    object-fit: contain;
    object-position: center;
    transform: scale(1.65);
    transform-origin: center;
  }

  .linhaDataGeral{
    margin:0 0 12px;
    font-size:14px;
    color:#444;
    font-weight:900;
  }

  .orcamento{
    border:1px solid #f0f0f0;
    border-radius:12px;
    padding:14px;
    margin-top:12px;
  }
  .orcamento:first-child{ margin-top:0; }

  .total-red{
    color:var(--vermelho);
    font-weight:900;
    font-size: 1.05em;
  }

  /* ===== Tabela ===== */
  .tabela-wrap{
    position:relative;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling: touch;
    border-radius:10px;
  }

  .tabela-wrap::before{
    content:"";
    position:absolute;
    left:0;
    right:0;
    top:110px;
    bottom:0;
    background-image:url("logo-reinvent.png");
    background-repeat:no-repeat;
    background-position:center 55%;
    background-size:55%;
    opacity:.06;
    z-index:0;
    pointer-events:none;
  }

  .tabela-wrap table,
  .tabela-wrap th,
  .tabela-wrap td{
    position:relative;
    z-index:1;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    table-layout:fixed;
  }

  .tabela-precos{ min-width: 520px; }
  .tabela-wrap table{ font-size:14px; }

  th, td{
    padding:8px 10px;
    border:1px solid #ddd;
    text-align:center;
    vertical-align:middle;
    overflow:visible;
  }

  thead .cab th{
    background:var(--azul);
    color:#fff;
    white-space:normal;
    line-height:1.15;
    font-size:12px;
    padding:7px 6px;
  }

  thead .titulo-tabela th{
    background:#fff;
    color:#111;
    font-size:11px;
    font-weight:900;
    padding:10px 8px;
    border:1px solid #ddd;
  }

  tbody td{ white-space:nowrap; }

  .taxa-adesao{
    margin-top:10px;
    text-align:right;
    font-size:14px;
    font-weight:900;
    color:#333;
    line-height:1.3;
  }

  .totais{
    margin-top:12px;
    font-weight:900;
    display:grid;
    gap:6px;
    line-height:1.25;
    font-size:13px;
  }

  .odonto-info{
    margin-top:8px;
    font-size:12px;
    font-weight:900;
    color:#333;
    text-align:right;
  }

  .share{
    margin-top:12px;
    width:100%;
    padding:10px;
    background:var(--verde);
    color:#fff;
    border:none;
    border-radius:10px;
    font-size:15px;
    font-weight:900;
    cursor:pointer;
  }

  /* ===== Ajuda passo a passo ===== */
  .ajuda-passo{
    margin-top:18px;
    padding:14px 6px;
    text-align:center;
    color:#555;
    font-size:14px;
    line-height:1.5;
  }
  .ajuda-titulo{
    font-weight:900;
    color:#333;
    margin-bottom:8px;
  }
  .ajuda-linha{ margin-top:4px; }

  /* ===== Tabela completa com cor suave (apenas quando marcado) ===== */
  .orcamento.tabela-completa{
    --tbl:#e8f2ff; /* fallback */
  }
  .orcamento.tabela-completa .tabela-wrap::before{
    top:76px; /* cabeçalho menor no modo completo */
  }
  .orcamento.tabela-completa table th,
  .orcamento.tabela-completa table td{
    background: var(--tbl);
  }
  .orcamento.tabela-completa thead .cab th{
    background: rgba(0,0,0,0.06);
    color:#111;
  }
  .orcamento.tabela-completa thead .titulo-tabela th{
    background: rgba(255,255,255,0.65);
  }

  @media (max-width:520px){
    .logo-wrap{ width:160px; height:52px; }
    .tabela-wrap::before{ top:118px; }

    .grupo-plano{
      grid-template-columns: 1.55fr auto;
      gap:8px;
    }
    .tipo{
      padding:9px 12px;
      font-size:13px;
      min-height:38px;
    }
    .opcao{
      padding:9px 10px;
      min-width:84px;
      min-height:38px;
      font-size:12px;
    }
  }

  /* ===== MODO CAPTURA (só na imagem) ===== */
  body.capturando #areaImagem{
    width: 760px;
    max-width: 760px;
  }
  body.capturando .tabela-wrap{ overflow: visible; }

  body.capturando .tabela-precos th,
  body.capturando .tabela-precos td{
    overflow: visible;
    white-space: nowrap;
    font-size: 20px;
  }

  body.capturando .totais{
    font-size: 17px;
    line-height: 1.25;
  }
  body.capturando .total-red{ font-size: 18px; }

  body.capturando .tabela-precos thead th{ white-space: normal; }

  @media (max-width: 420px){
    .tabela-wrap table{ font-size:13px; }
    th, td{ padding:6px 6px; }

    thead .cab th{
      font-size:11px;
      padding:6px 4px;
    }

    thead .titulo-tabela th{
      font-size:12px;
      padding:8px 6px;
    }
  }
</style>
</head>

<body>
<div class="toast" id="toast"></div>

<div class="container" id="app">
  <div class="titulo">REINVENT SAÚDE - COTADOR</div>
  <div class="subtitulo">Fortaleza - CE</div>

  <div class="planos">
    <div class="grupo-plano" data-plan="ind_enf">
      <button class="tipo" onclick="toggleTipo('ind_enf')"><small>IND - ENFERMARIA</small></button>
      <div class="opcoes">
        <button class="opcao disabled" data-plan="ind_enf" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
        <button class="opcao disabled" data-plan="ind_enf" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
      </div>
    </div>

    <div class="grupo-plano" data-plan="ind_amb">
      <button class="tipo" onclick="toggleTipo('ind_amb')"><small>IND - AMBULATORIAL</small></button>
      <div class="opcoes">
        <button class="opcao disabled" data-plan="ind_amb" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
        <button class="opcao disabled" data-plan="ind_amb" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
      </div>
    </div>

    <div class="grupo-plano" data-plan="ind_apto">
      <button class="tipo" onclick="toggleTipo('ind_apto')"><small>IND - APARTAMENTO</small></button>
      <div class="opcoes">
        <button class="opcao disabled" data-plan="ind_apto" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
        <button class="opcao disabled" data-plan="ind_apto" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
      </div>
    </div>

    <div class="grupo-plano" data-plan="ss_enf">
      <button class="tipo" onclick="toggleTipo('ss_enf')"><small>SS - ENFERMARIA</small></button>
      <div class="opcoes">
        <button class="opcao disabled" data-plan="ss_enf" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
        <button class="opcao disabled" data-plan="ss_enf" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
      </div>
    </div>

    <div class="grupo-plano" data-plan="ss_amb">
      <button class="tipo" onclick="toggleTipo('ss_amb')"><small>SS - AMBULATORIAL</small></button>
      <div class="opcoes">
        <button class="opcao disabled" data-plan="ss_amb" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
        <button class="opcao disabled" data-plan="ss_amb" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
      </div>
    </div>
  </div>

  <div class="idades">
    <textarea id="idades" placeholder="Digite as idades separadas por vírgula. Ex: 23, 35, 62"></textarea>
  </div>

  <div class="linha-opcoes" id="opcoesExtras"></div>

  <button class="calcular" onclick="calcular()">Calcular Orçamento</button>
  <div id="ancoraResultado"></div>

  <!-- AJUDA PASSO A PASSO -->
  <div id="ajudaPasso" class="ajuda-passo">
    <div class="ajuda-titulo">Não sabe como cotar?</div>
    <div class="ajuda-linha">1️⃣ Selecione o <b>tipo de plano</b></div>
    <div class="ajuda-linha">2️⃣ Escolha <b>Parcial</b> ou <b>Total</b> (pode fazer <b>2 orçamentos</b>)</div>
    <div class="ajuda-linha">3️⃣ Digite as <b>idades</b> (ou marque <b>Tabela completa</b>)</div>
    <div class="ajuda-linha">4️⃣ Clique em <b>Calcular</b></div>
    <div class="ajuda-linha">5️⃣ Clique em <b>Compartilhar</b> ou <b>Baixar</b> e pronto ✅</div>
  </div>

  <div id="resultado">
    <div id="areaImagem">
      <div class="logos">
        <div class="logo-wrap">
          <img src="logo-reinvent.png" class="logo reinvent" alt="Reinvent Saúde" />
        </div>
        <div class="logo-wrap">
          <img src="logo-hapvida.png" class="logo hapvida" alt="Hapvida" />
        </div>
      </div>

      <div class="linhaDataGeral" id="linhaDataGeral"></div>
      <div id="orcamentosContainer"></div>
    </div>

    <div style="display:grid; gap:8px; margin-top:10px;">
      <button class="share" onclick="gerarImagem('share')">Compartilhar Orçamento</button>
      <button class="share" style="background:#005baa;" onclick="gerarImagem('download')">Baixar Orçamento</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const LIMITE_ORCAMENTOS = 2;
  const ODONTO_POR_VIDA = 23.25;

  // cores suaves (sem verde) — usadas APENAS no modo "Tabela completa"
  const CORES_TABELA_COMPLETA = [
    "#e8f2ff", // azul clarinho
    "#efe8ff", // lilás claro
    "#fff1e3", // pêssego claro
    "#ffe9ea", // rosado claro
    "#fff0f0"  // vermelho bem claro
  ];

  const tiposAtivos = new Set();
  let selecionados = [];

  const nomesClienteBase = {
    ind_enf: "NOSSO PLANO ENFERMARIA COPARTICIPAÇÃO",
    ind_amb: "NOSSO PLANO AMBULATORIAL COPARTICIPAÇÃO",
    ind_apto:"NOSSO PLANO APARTAMENTO COPARTICIPAÇÃO",
    ss_enf:  "SUPER SIMPLES ENFERMARIA COPARTICIPAÇÃO",
    ss_amb:  "SUPER SIMPLES AMBULATORIAL COPARTICIPAÇÃO"
  };

  function isSuperSimples(tipo){
    return typeof tipo === "string" && tipo.startsWith("ss_");
  }

  function nomeClienteCompletoHTML(tipo, modo){
    let base = nomesClienteBase[tipo] || "";
    if(isSuperSimples(tipo)){
      base = base.replace(/^SUPER SIMPLES /, "PLANO EMPRESARIAL ");
    }
    const mod = (modo || "").toUpperCase();
    if(mod === "TOTAL"){
      return `${base} <span class="total-red">TOTAL</span>`;
    }
    return `${base} ${mod}`.trim();
  }

  function dataHojeBR(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  function formatarBR(valor){
    return Number(valor).toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  const tabelas = {
    ind_enf_parcial: [
      ["00 a 18",0,18,241.68,205.43],["19 a 23",19,23,311.18,264.50],["24 a 28",24,28,354.18,301.05],
      ["29 a 33",29,33,393.74,334.68],["34 a 38",34,38,412.20,350.37],["39 a 43",39,43,462.60,393.21],
      ["44 a 48",44,48,558.98,475.13],["49 a 53",49,53,762.08,647.77],["54 a 58",54,58,1020.23,867.20],
      ["59+",59,200,1318.95,1121.11]
    ],
    ind_enf_total: [
      ["00 a 18",0,18,198.23,168.50],["19 a 23",19,23,253.82,215.75],["24 a 28",24,28,288.22,244.99],
      ["29 a 33",29,33,319.87,271.89],["34 a 38",34,38,334.64,284.44],["39 a 43",39,43,374.96,318.72],
      ["44 a 48",44,48,452.06,384.25],["49 a 53",49,53,614.53,522.35],["54 a 58",54,58,821.04,697.88],
      ["59+",59,200,1060.00,901.00]
    ],
    ind_amb_parcial: [
      ["00 a 18",0,18,202.80,172.38],["19 a 23",19,23,267.06,227.00],["24 a 28",24,28,304.44,258.77],
      ["29 a 33",29,33,339.61,288.67],["34 a 38",34,38,357.41,303.80],["39 a 43",39,43,401.25,341.06],
      ["44 a 48",44,48,490.67,417.07],["49 a 53",49,53,680.53,578.45],["54 a 58",54,58,917.37,779.76],
      ["59+",59,200,1191.43,1012.72]
    ],
    ind_amb_total: [
      ["00 a 18",0,18,130.22,110.69],["19 a 23",19,23,171.04,145.38],["24 a 28",24,28,194.78,165.56],
      ["29 a 33",29,33,217.12,184.55],["34 a 38",34,38,228.42,194.16],["39 a 43",39,43,256.27,217.83],
      ["44 a 48",44,48,313.06,266.10],["49 a 53",49,53,433.65,368.60],["54 a 58",54,58,584.08,496.47],
      ["59+",59,200,758.15,644.43]
    ],
    ind_apto_parcial: [
      ["00 a 18",0,18,350.27,297.73],["19 a 23",19,23,454.52,386.34],["24 a 28",24,28,519.02,441.17],
      ["29 a 33",29,33,578.36,491.61],["34 a 38",34,38,606.05,515.14],["39 a 43",39,43,681.65,579.40],
      ["44 a 48",44,48,826.22,702.29],["49 a 53",49,53,1130.87,961.24],["54 a 58",54,58,1518.10,1290.39],
      ["59+",59,200,1966.18,1671.25]
    ],
    ind_apto_total: [
      ["00 a 18",0,18,285.10,242.34],["19 a 23",19,23,368.49,313.22],["24 a 28",24,28,420.09,357.08],
      ["29 a 33",29,33,467.56,397.43],["34 a 38",34,38,489.71,416.25],["39 a 43",39,43,550.19,467.66],
      ["44 a 48",44,48,665.84,565.96],["49 a 53",49,53,909.55,773.12],["54 a 58",54,58,1219.32,1036.42],
      ["59+",59,200,1577.77,1341.10]
    ],
    ss_enf_parcial: [
      ["00 a 18",0,18,187.76,159.60],["19 a 23",19,23,210.29,178.75],["24 a 28",24,28,235.52,200.19],
      ["29 a 33",29,33,270.85,230.22],["34 a 38",34,38,311.48,264.76],["39 a 43",39,43,370.66,315.06],
      ["44 a 48",44,48,463.33,393.83],["49 a 53",49,53,579.16,492.29],["54 a 58",54,58,984.57,836.88],
      ["59+",59,200,1102.72,937.31]
    ],
    ss_enf_total: [
      ["00 a 18",0,18,146.72,124.71],["19 a 23",19,23,164.33,139.68],["24 a 28",24,28,184.05,156.44],
      ["29 a 33",29,33,211.66,179.91],["34 a 38",34,38,243.41,206.90],["39 a 43",39,43,289.66,246.21],
      ["44 a 48",44,48,362.08,307.77],["49 a 53",49,53,452.60,384.71],["54 a 58",54,58,769.42,654.01],
      ["59+",59,200,861.75,732.49]
    ],
    ss_amb_parcial: [
      ["00 a 18",0,18,139.18,118.30],["19 a 23",19,23,155.88,132.50],["24 a 28",24,28,174.59,148.40],
      ["29 a 33",29,33,200.78,170.66],["34 a 38",34,38,230.90,196.27],["39 a 43",39,43,274.77,233.55],
      ["44 a 48",44,48,343.46,291.94],["49 a 53",49,53,429.33,364.93],["54 a 58",54,58,729.86,620.38],
      ["59+",59,200,817.44,694.82]
    ],
    ss_amb_total: [
      ["00 a 18",0,18,102.77,87.35],["19 a 23",19,23,115.10,97.84],["24 a 28",24,28,128.91,109.57],
      ["29 a 33",29,33,148.25,126.01],["34 a 38",34,38,170.49,144.92],["39 a 43",39,43,202.88,172.45],
      ["44 a 48",44,48,253.60,215.56],["49 a 53",49,53,317.00,269.45],["54 a 58",54,58,538.90,458.07],
      ["59+",59,200,603.57,513.03]
    ]
  };

  function encontrarFaixa(lista, idade){
    return lista.find(f => idade >= f[1] && idade <= f[2]);
  }

  let toastTimer = null;
  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.classList.remove("show"), 1600);
  }

  function esconderAjuda(){
    const ajuda = document.getElementById("ajudaPasso");
    if(ajuda) ajuda.style.display = "none";
  }
  function mostrarAjuda(){
    const ajuda = document.getElementById("ajudaPasso");
    if(ajuda) ajuda.style.display = "block";
  }

  function limparResultado(){
    document.getElementById("resultado").style.display = "none";
    document.getElementById("orcamentosContainer").innerHTML = "";
    mostrarAjuda();
  }

  function isTabelaCompleta(){
    const el = document.getElementById("tabelaCompleta");
    return !!(el && el.checked);
  }

  function setIdadesEnabled(enabled){
    const t = document.getElementById("idades");
    if(!t) return;
    t.disabled = !enabled;
    if(!enabled) t.value = "";
  }

  function atualizarCheckboxes(){
    const temIND = selecionados.some(s => !isSuperSimples(s.tipo));
    const temSS  = selecionados.some(s => isSuperSimples(s.tipo));
    const completa = isTabelaCompleta();

    const container = document.getElementById("opcoesExtras");
    container.innerHTML = "";

    // sempre aparece se houver seleção (pra pessoa não esquecer que existe)
    if(temIND || temSS){
      container.insertAdjacentHTML("beforeend", `
        <label class="opt-label">
          <input type="checkbox" id="tabelaCompleta" onchange="onToggleTabelaCompleta()" />
          Tabela completa (não precisa digitar idades)
        </label>
      `);
    }

    // se tabela completa: não mostra 5% familiar
    if(!completa && temIND){
      container.insertAdjacentHTML("beforeend", `
        <label class="opt-label">
          <input type="checkbox" id="familiar1grau" />
          Familiar 1º grau (5% sobre o valor)
        </label>
      `);
    }

    if(temSS){
      container.insertAdjacentHTML("beforeend", `
        <label class="opt-label">
          <input type="checkbox" id="odontoSS" />
          Odonto (somar R$ ${formatarBR(ODONTO_POR_VIDA)} por beneficiário)
        </label>
      `);
    }

    // re-aplica estado do checkbox tabela completa se ele existia antes
    // (porque recriamos o HTML)
    const old = document.querySelector('input[data-keep="tabelaCompleta"]');
  }

  function onToggleTabelaCompleta(){
    const completa = isTabelaCompleta();
    setIdadesEnabled(!completa);
    limparResultado();
    atualizarOpcoesAtivas(); // para esconder familiar se marcar
  }

  function atualizarOpcoesAtivas(){
    document.querySelectorAll(".grupo-plano").forEach(grupo=>{
      const plan = grupo.dataset.plan;
      const tipoBtn = grupo.querySelector(".tipo");
      const ativo = tiposAtivos.has(plan);

      if(ativo) tipoBtn.classList.add("ativo");
      else tipoBtn.classList.remove("ativo");

      grupo.querySelectorAll(".opcao").forEach(op=>{
        if(ativo) op.classList.remove("disabled");
        else{
          op.classList.add("disabled");
          op.classList.remove("ativo");
        }
      });
    });

    document.querySelectorAll(".opcao").forEach(op=>{
      const tipo = op.dataset.plan;
      const modo = op.dataset.modo;
      const selected = selecionados.some(s => s.tipo===tipo && s.modo===modo);
      if(selected) op.classList.add("ativo");
      else op.classList.remove("ativo");
    });

    // reconstruir opções extras (mantendo estado do "tabela completa" se existir)
    const tinhaTabelaCompleta = !!document.getElementById("tabelaCompleta")?.checked;
    const tinhaFamiliar = !!document.getElementById("familiar1grau")?.checked;
    const tinhaOdonto = !!document.getElementById("odontoSS")?.checked;

    atualizarCheckboxes();

    if(document.getElementById("tabelaCompleta")){
      document.getElementById("tabelaCompleta").checked = tinhaTabelaCompleta;
      setIdadesEnabled(!tinhaTabelaCompleta);
    }
    if(document.getElementById("familiar1grau")){
      document.getElementById("familiar1grau").checked = tinhaFamiliar;
    }
    if(document.getElementById("odontoSS")){
      document.getElementById("odontoSS").checked = tinhaOdonto;
    }
  }

  function toggleTipo(planKey){
    if(tiposAtivos.has(planKey)){
      tiposAtivos.delete(planKey);
      selecionados = selecionados.filter(s => s.tipo !== planKey);
      limparResultado();
      atualizarOpcoesAtivas();
      return;
    }
    tiposAtivos.add(planKey);
    limparResultado();
    atualizarOpcoesAtivas();
  }

  function toggleModo(btn){
    const tipo = btn.dataset.plan;
    const modo = btn.dataset.modo;

    if(!tiposAtivos.has(tipo) || btn.classList.contains("disabled")) return;

    const idx = selecionados.findIndex(s => s.tipo===tipo && s.modo===modo);

    if(idx >= 0){
      selecionados.splice(idx, 1);
      limparResultado();
      atualizarOpcoesAtivas();
      return;
    }

    if(selecionados.length >= LIMITE_ORCAMENTOS){
      showToast("Máximo de 2 orçamentos por vez.");
      return;
    }

    selecionados.push({ tipo, modo });
    limparResultado();
    atualizarOpcoesAtivas();
  }

  function parseIdades(){
    return document.getElementById("idades").value
      .split(",")
      .map(s => parseInt(s.trim(), 10))
      .filter(n => Number.isFinite(n));
  }

  function taxaAdesaoTexto(tipo, vidas){
    if(isSuperSimples(tipo)){
      return `Taxa de adesão: R$ 20,00 por beneficiário (R$ ${formatarBR(20*vidas)})`;
    }
    return `Taxa de adesão: R$ 35,00 por contrato`;
  }

  function blurActive(){
    if (document.activeElement) document.activeElement.blur();
  }

  function colgroupHTML(cols){
    // cols é um array de widths em %
    return `
      <colgroup>
        ${cols.map(w => `<col style="width:${w}%">`).join("")}
      </colgroup>
    `;
  }

  function cabecalhoTabelaHTML({ completa, familiar }){
    if(completa){
      return `
        <tr class="cab">
          <th>Faixa<br>Etária</th>
          <th>VALOR</th>
        </tr>
      `;
    }
    if(familiar){
      return `
        <tr class="cab">
          <th>Faixa<br>Etária</th>
          <th>Idade</th>
          <th>VALOR</th>
        </tr>
      `;
    }
    return `
      <tr class="cab">
        <th>Faixa<br>Etária</th>
        <th>Idade</th>
        <th>VALOR</th>
      </tr>
    `;
  }

  function calcular(){
    blurActive();

    if(selecionados.length === 0){
      alert("Selecione até 2 orçamentos (tipo + parcial/total).");
      return;
    }

    esconderAjuda();

    const completa = isTabelaCompleta();

    let idades = [];
    if(!completa){
      idades = parseIdades();
      if(idades.length === 0){
        alert("Informe ao menos uma idade (ex: 23, 35, 62) OU marque Tabela completa.");
        return;
      }
    }

    // GA evento ao calcular
    if (typeof gtag === "function") {
      gtag("event", "orcamento_calculado", {
        orcamentos_qtd: selecionados.length,
        tabela_completa: completa ? 1 : 0,
        tem_ss: selecionados.some(s => isSuperSimples(s.tipo)) ? 1 : 0,
        tem_ind: selecionados.some(s => !isSuperSimples(s.tipo)) ? 1 : 0
      });
    }

    for(const sel of selecionados){
      if(!completa && isSuperSimples(sel.tipo) && idades.length < 2){
        alert("Plano Empresarial (SS): mínimo 2 vidas (duas idades).");
        return;
      }
    }

    const familiarEl = document.getElementById("familiar1grau");
    const odontoEl   = document.getElementById("odontoSS");

    const familiarAtivo = (!completa && familiarEl) ? familiarEl.checked : false; // completa: não usa
    const odontoAtivo   = odontoEl ? odontoEl.checked : false;

    const cont = document.getElementById("orcamentosContainer");
    cont.innerHTML = "";

    document.getElementById("linhaDataGeral").textContent = `Orçamento dia ${dataHojeBR()}`;
    document.getElementById("resultado").style.display = "block";

    selecionados.forEach((sel, idxOrc)=>{
      const chave = `${sel.tipo}_${sel.modo}`;
      const lista = tabelas[chave];
      if(!lista){
        alert("Tabela não encontrada para um dos planos selecionados.");
        return;
      }

      const isSS = isSuperSimples(sel.tipo);
      const aplicarFamiliar = (!completa) && (!isSS) && familiarAtivo;
      const aplicarOdonto   = (isSS) && odontoAtivo;

      let total = 0;
      let total5 = 0;

      let rowsHTML = "";

      if(completa){
        // TABELA COMPLETA: só faixas e valor (sem idade)
        lista.forEach(faixa=>{
          let vN = Number(faixa[3]) || 0;

          if(aplicarOdonto){
            // no modo tabela completa, odonto soma "por beneficiário".
            // Como não há idades/vidas aqui, exibimos o valor com odonto SOMADO 1x,
            // e colocamos o aviso abaixo (para não "mentir" total).
            // -> mais correto: manter sem somar e só avisar.
            // Você pediu "somar por beneficiário" (faz sentido quando tem idades).
            // Então aqui vamos: NÃO somar no valor da faixa. Só avisar.
          }

          rowsHTML += `
            <tr>
              <td>${faixa[0]}</td>
              <td>R$ ${formatarBR(vN)}</td>
            </tr>
          `;
        });

      } else {
        // ORÇAMENTO POR IDADES
        idades.forEach(idade=>{
          const faixa = encontrarFaixa(lista, idade);
          if(!faixa) return;

          let vN = Number(faixa[3]) || 0;

          if(aplicarOdonto){
            vN += ODONTO_POR_VIDA;
          }

          const v5 = vN * 0.95;

          total += vN;
          total5 += v5;

          if(aplicarFamiliar){
            rowsHTML += `
              <tr>
                <td>${faixa[0]}</td>
                <td>${idade}</td>
                <td>R$ ${formatarBR(v5)}</td>
              </tr>
            `;
          } else {
            rowsHTML += `
              <tr>
                <td>${faixa[0]}</td>
                <td>${idade}</td>
                <td>R$ ${formatarBR(vN)}</td>
              </tr>
            `;
          }
        });
      }

      const nomeDentroTabelaHTML = nomeClienteCompletoHTML(sel.tipo, sel.modo);

      // colunas e colspan
      let cols = [];
      let colCount = 0;

      if(completa){
        cols = [55,45]; // faixa / valor
        colCount = 2;
      } else {
        cols = [42,18,40]; // faixa / idade / valor
        colCount = 3;
      }

      const taxa = (!completa) ? taxaAdesaoTexto(sel.tipo, idades.length) : "";

      let totalHTML = "";
      if(!completa){
        if(aplicarFamiliar){
          totalHTML = `Total 5% Familiar: R$ ${formatarBR(total5)}`;
        } else {
          totalHTML = `Total: R$ ${formatarBR(total)}`;
        }
      } else {
        totalHTML = `Tabela completa por faixa etária`;
      }

      let odontoInfo = "";
      if(aplicarOdonto){
        if(completa){
          odontoInfo = `<div class="odonto-info">Odonto: + R$ ${formatarBR(ODONTO_POR_VIDA)} por beneficiário (aplicado quando você usa idades)</div>`;
        } else {
          const totalOdonto = ODONTO_POR_VIDA * idades.length;
          odontoInfo = `<div class="odonto-info">Odonto: R$ ${formatarBR(ODONTO_POR_VIDA)} por beneficiário (R$ ${formatarBR(totalOdonto)}) — incluído nos valores</div>`;
        }
      }

      // cor (somente se tabela completa)
      const cor = CORES_TABELA_COMPLETA[idxOrc % CORES_TABELA_COMPLETA.length];
      const classeCompleta = completa ? "tabela-completa" : "";
      const styleTbl = completa ? `style="--tbl:${cor};"` : "";

      cont.insertAdjacentHTML("beforeend", `
        <div class="orcamento ${classeCompleta}" ${styleTbl}>
          <div class="tabela-wrap">
            <table class="tabela-precos">
              ${colgroupHTML(cols)}
              <thead>
                <tr class="titulo-tabela">
                  <th colspan="${colCount}">${nomeDentroTabelaHTML}</th>
                </tr>
                ${cabecalhoTabelaHTML({ completa, familiar: aplicarFamiliar })}
              </thead>
              <tbody>
                ${rowsHTML}
              </tbody>
            </table>
          </div>

          ${taxa ? `<div class="taxa-adesao">${taxa}</div>` : ""}

          <div class="totais">
            <div>${totalHTML}</div>
          </div>

          ${odontoInfo}
        </div>
      `);
    });

    setTimeout(() => {
      document.getElementById("ancoraResultado").scrollIntoView({
        behavior: "smooth",
        block: "start"
      });
    }, 200);
  }

  async function gerarImagem(modo = "share"){
    const area = document.getElementById("areaImagem");

    document.body.classList.add("capturando");
    await new Promise(r => requestAnimationFrame(() => r()));

    const canvas = await html2canvas(area, {
      backgroundColor: "#ffffff",
      useCORS: true,
      scale: 3
    });

    document.body.classList.remove("capturando");

    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
    if(!blob){
      alert("Não foi possível gerar a imagem. Tente novamente.");
      return;
    }

    const file = new File([blob], "orcamento_reinvent_hapvida.png", { type:"image/png" });

    if(modo === "share"){
      const podeCompartilhar =
        navigator.share &&
        (!navigator.canShare || navigator.canShare({ files:[file] }));

      if(podeCompartilhar){
        try{
          await navigator.share({ title: "Orçamento", files: [file] });
          return;
        } catch(e){
          return;
        }
      }

      alert("No seu iPhone, o compartilhamento não ficou disponível. Use 'Baixar Orçamento' e compartilhe pela galeria.");
      return;
    }

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "orcamento_reinvent_hapvida.png";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // inicial
  atualizarOpcoesAtivas();
</script>
</body>
</html>
