<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WRRZ5R5EXZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-WRRZ5R5EXZ');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COTADOR</title>

  <style>
    :root{
      --azul:#005baa;
      --bg:#f5f7fb;
      --verde:#28a745; /* (mantido só pra consistência; botões estão em azul) */
      --borda:#d9d9d9;
      --texto:#111;
      --vermelho:#c62828;

      /* chips */
      --chip-borda: rgba(0,91,170,0.35);
      --chip-shadow: 0 6px 14px rgba(0,0,0,0.06);
    }

    body{
      font-family: Arial, sans-serif;
      background:var(--bg);
      margin:0;
      padding:12px;
    }

    .container{
      max-width:900px;
      margin:auto;
      background:#fff;
      border-radius:12px;
      padding:15px;
      box-shadow:0 0 10px rgba(0,0,0,0.08);
    }

    .titulo{
      text-align:center;
      color:var(--azul);
      margin:6px 0 2px;
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .subtitulo{
      text-align:center;
      color:#3a3a3a;
      margin:0 0 14px;
      font-size:14px;
      font-weight:700;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:50%;
      top:16px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:13px;
      font-weight:800;
      box-shadow:0 8px 20px rgba(0,0,0,.22);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(4px);
    }

    /* ===== Layout chips ===== */
    .planos{
      display:grid;
      gap:16px;
    }

    .grupo-plano{
      display:grid;
      grid-template-columns: 1.7fr auto;
      gap:14px;
      align-items:center;
    }

    .tipo, .opcao{
      border:2px solid var(--chip-borda);
      border-radius:999px;
      background:#fff;
      color:var(--azul);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      box-shadow: var(--chip-shadow);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease, opacity .12s ease;
    }

    .tipo{
      padding:10px 14px;
      font-size:14px;
      text-align:left;
      line-height:1.05;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      min-height:40px;
    }
    .tipo small{
      font-size:14px;
      display:block;
      font-weight:900;
      opacity:.95;
    }

    .opcoes{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }

    .opcao{
      padding:10px 14px;
      font-size:13px;
      min-height:40px;
      min-width:92px;
    }

    .tipo:hover, .opcao:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
    }

    .ativo{
      background:var(--azul) !important;
      color:#fff !important;
      border-color: var(--azul) !important;
      box-shadow:0 10px 18px rgba(0,91,170,0.28) !important;
      transform: translateY(-1px);
    }

    .opcao.disabled{
      opacity:0.35;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
      background:#f2f4f7;
      border-color:#ddd;
      color:#999;
    }

    /* ===== Entrada ===== */
    .idades{ margin-top:12px; }

    #idades{
      width:100%;
      height:40px;
      padding:8px 10px;
      border:2px solid var(--borda);
      border-radius:10px;
      box-sizing:border-box;
      resize:none;
      font-size:16px; /* iOS: evita zoom */
    }

    .linha-opcoes{
      margin-top:10px;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      font-size:14px;
    }

    .opt-label{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      color:#333;
    }

    .calcular{
      width:100%;
      margin-top:12px;
      padding:12px;
      background:var(--azul);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      transition:opacity .15s ease;
    }
    .calcular:hover{ opacity:0.92; }

    /* ===== Resultado ===== */
    #resultado{ display:none; margin-top:16px; }

    .capture-area{
      border:1px solid #eee;
      border-radius:12px;
      padding:14px;
      background:#fff;
      overflow: visible;
    }

    /* ✅ Logos agora ficam centralizadas */
    .logos{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-bottom:8px;
    }

    .logo-wrap{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:visible;
      min-height:64px;
    }

    /* ✅ Logo com tamanho consistente (tela + captura) */
    .logo{
      width: 220px;
      max-width: 80%;
      height:auto;
      display:block;
      object-fit:contain;
    }

    .linhaDataGeral{
      margin:0 0 12px;
      font-size:14px;
      color:#444;
      font-weight:900;
    }

    .orcamento{
      border:1px solid #f0f0f0;
      border-radius:12px;
      padding:14px;
      margin-top:12px;
      background:#fff;
    }
    .orcamento:first-child{ margin-top:0; }

    .total-red{
      color:var(--vermelho);
      font-weight:900;
      font-size: 1.05em;
    }

    /* ===== Tabela ===== */
    .tabela-wrap{
      position:relative;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      border-radius:10px;
    }

    .tabela-completa .tabela-wrap::before{
      opacity: .16; /* mais forte só na completa */
    }

    .tabela-wrap table,
    .tabela-wrap th,
    .tabela-wrap td{
      position:relative;
      z-index:1;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      table-layout:fixed;
    }

    .tabela-precos{ min-width: 520px; }
    .tabela-wrap table{ font-size:14px; }

    th, td{
      padding:8px 10px;
      border:1px solid #ddd;
      text-align:center;
      vertical-align:middle;
      overflow:visible;
    }

    /* ✅ FAIXA AZUL */
    thead .cab th{
      background:var(--azul);
      color:#fff;
      white-space:normal;
      line-height:1.15;
      font-size:12px;
      padding:7px 6px;
    }

    thead .titulo-tabela th{
      background:#fff;
      color:#111;
      font-size:11px;
      font-weight:900;
      padding:10px 8px;
      border:1px solid #ddd;
    }

    tbody td{ white-space:nowrap; }

    .taxa-adesao{
      margin-top:10px;
      text-align:right;
      font-size:14px;
      font-weight:900;
      color:#333;
      line-height:1.3;
    }

    .ss-aviso{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color: #444;
      text-align: right;
    }
    body.capturando .ss-aviso{ font-size: 13px; }

    .totais{
      margin-top:12px;
      font-weight:900;
      display:grid;
      gap:6px;
      line-height:1.25;
      font-size:13px;
    }

    .odonto-info{
      margin-top:8px;
      font-size:12px;
      font-weight:900;
      color:#333;
      text-align:right;
    }

    .familiar-info{
      margin-top:8px;
      font-size:12px;
      font-weight:900;
      color:#444;
      text-align:right;
    }
    body.capturando .familiar-info{ font-size:13px; }

    .share{
      margin-top:12px;
      width:100%;
      padding:10px;
      background:#2f7dff;
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }

    /* ===== Cores suaves (SÓ tabela completa) - sem verde ===== */
    .tabela-completa.tblc-1 { background:#eef5ff; }
    .tabela-completa.tblc-2 { background:#f3efff; }
    .tabela-completa.tblc-3 { background:#fff1f1; }
    .tabela-completa.tblc-4 { background:#fff6e9; }
    .tabela-completa.tblc-5 { background:#f0fbff; }
    .tabela-completa.tblc-6 { background:#f7f2ff; }

    .tabela-completa .tabela-wrap table { background: transparent; }
    .tabela-completa .tabela-wrap tbody td{ background: rgba(255,255,255,0.55); }
    .tabela-completa .titulo-tabela th{ background: rgba(255,255,255,0.75); }

    @media (max-width:520px){
      .grupo-plano{ grid-template-columns: 1.55fr auto; gap:8px; }
      .tipo{ padding:9px 12px; font-size:13px; min-height:38px; }
      .opcao{ padding:9px 10px; min-width:84px; min-height:38px; font-size:12px; }

      .logo{
        width: 180px;
        max-width: 85%;
      }
    }

    /* ===== MODO CAPTURA ===== */
    body.capturando .capture-area{ width: 760px; max-width: 760px; }
    body.capturando .tabela-wrap{ overflow: visible; }
    body.capturando .tabela-precos th,
    body.capturando .tabela-precos td{
      overflow: visible;
      white-space: nowrap;
      font-size: 20px;
    }
    body.capturando .totais{ font-size: 17px; line-height: 1.25; }
    body.capturando .total-red{ font-size: 18px; }
    body.capturando .tabela-precos thead th{ white-space: normal; }

    /* ===== Ajuda passo a passo ===== */
    .ajuda-passo{
      margin-top:18px;
      padding:14px 6px;
      text-align:center;
      color:#555;
      font-size:14px;
      line-height:1.5;
    }
    .ajuda-titulo{
      font-weight:900;
      color:#333;
      margin-bottom:8px;
    }
    .ajuda-linha{ margin-top:4px; }

    /* ===== Caixa de Novidades ===== */
    .novidades-box{
      margin: 10px 0 14px;
      border: 1px solid #d9e3f2;
      background: #f3f7fd;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      color: #333;
    }
    .novidades-topo{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:900;
      color:#005baa;
      margin-bottom:6px;
    }
    .novidades-topo button{
      background:none;
      border:none;
      font-size:16px;
      cursor:pointer;
      color:#666;
    }
    .novidades-conteudo{ line-height:1.45; }

    /* NÃO aparece na imagem */
    body.capturando .novidades-box{ display:none !important; }

    /* ===== BOTÃO INFO (COPART/CARÊNCIA) ===== */
    .btn-info-central{
      width:100%;
      display:flex;
      justify-content:center;
      margin: 8px 0 14px;
    }
    .btn-info-central button{
      width:min(520px, 100%);
      padding:12px 14px;
      border:none;
      border-radius:999px;
      background: var(--azul);
      color:#fff;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(0,91,170,0.25);
      transition: opacity .15s ease, transform .12s ease;
    }
    .btn-info-central button:hover{ opacity:.95; transform: translateY(-1px); }

    /* ===== MODAL INFO ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.38);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:9998;
    }
    .modal{
      width:min(640px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 16px 38px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal-header{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid #eee;
      font-weight:900;
      color:#111;
    }
    .modal-close{
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      color:#666;
      padding:6px 10px;
      border-radius:10px;
    }
    .modal-body{
      padding:12px 14px 14px;
      display:grid;
      gap:10px;
    }
    .modal-body .btn-modal{
      width:100%;
      border:none;
      border-radius:12px;
      padding:12px;
      font-weight:900;
      cursor:pointer;
      background:#2f7dff;
      color:#fff;
      font-size:15px;
    }
    .modal-body .btn-modal.secondary{
      background:#005baa;
    }
    .modal-hint{
      font-size:12px;
      font-weight:900;
      color:#555;
      line-height:1.35;
      margin-top:2px;
    }

    /* Modal nunca entra em captura */
    body.capturando .modal-overlay{ display:none !important; }

    /* ===== ÁREAS OFFSCREEN PARA CAPTURA ===== */
    .offscreen{
      position:absolute;
      left:-9999px;
      top:0;
      width:900px;
      pointer-events:none;
    }

    /* ===== TABELA SIMPLES (INFO) ===== */
    .info-title{
      margin: 2px 0 10px;
      font-weight:900;
      color:#111;
      text-align:center;
      font-size:14px;
    }
    .info-sub{
      margin: 0 0 10px;
      color:#444;
      font-weight:900;
      text-align:center;
      font-size:13px;
    }
    .info-grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .info-grid-2{ grid-template-columns:1fr; }
    }
    .info-card{
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .info-card .head{
      background:var(--azul);
      color:#fff;
      font-weight:900;
      padding:10px 12px;
      font-size:13px;
      text-align:center;
    }
    .info-card .body{
      padding:10px 12px;
      font-size:13px;
      font-weight:800;
      color:#222;
      display:grid;
      gap:8px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px dashed #e8e8e8;
      padding-bottom:6px;
    }
    .kv:last-child{ border-bottom:none; padding-bottom:0; }
    .kv span:first-child{ color:#333; font-weight:900; }
    .kv span:last-child{ color:#111; font-weight:900; text-align:right; }

    .carencias-section{
      border:1px solid #eee;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .carencias-section .head{
      background:var(--azul);
      color:#fff;
      font-weight:900;
      padding:10px 12px;
      font-size:13px;
    }
    .carencias-section .body{
      padding:10px 12px;
      font-size:13px;
      font-weight:800;
      color:#222;
      line-height:1.35;
    }
    .carencias-section ul{
      margin:8px 0 0 18px;
      padding:0;
    }
    .carencias-section li{ margin:4px 0; }

    .rodape-info{
      margin-top:10px;
      font-size:11.5px;
      font-weight:900;
      color:#555;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="container" id="app">
    <div class="titulo">COTADOR</div>
    <div class="subtitulo">Fortaleza - CE</div>

    <!-- CAIXA DE NOVIDADES -->
    <div id="novidadesBox" class="novidades-box" style="display:none;">
      <div class="novidades-topo">
        <strong>Novidades</strong>
        <button type="button" onclick="fecharNovidades()">✕</button>
      </div>
      <div class="novidades-conteudo">
        ✅ Novidade: <b>Layout mais limpo e focado na Hapvida. Removemos temporariamente a marca da corretora para evitar dúvidas e facilitar a venda.</b>
      </div>
    </div>

    <!-- ✅ BOTÃO CENTRAL -->
    <div class="btn-info-central">
      <button type="button" onclick="abrirModalInfo()">COPARTICIPAÇÕES/CARÊNCIA</button>
    </div>

    <div class="planos">
      <div class="grupo-plano" data-plan="ind_enf">
        <button type="button" class="tipo" onclick="toggleTipo('ind_enf')"><small>IND - ENFERMARIA</small></button>
        <div class="opcoes">
          <button type="button" class="opcao disabled" data-plan="ind_enf" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
          <button type="button" class="opcao disabled" data-plan="ind_enf" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
        </div>
      </div>

      <div class="grupo-plano" data-plan="ind_amb">
        <button type="button" class="tipo" onclick="toggleTipo('ind_amb')"><small>IND - AMBULATORIAL</small></button>
        <div class="opcoes">
          <button type="button" class="opcao disabled" data-plan="ind_amb" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
          <button type="button" class="opcao disabled" data-plan="ind_amb" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
        </div>
      </div>

      <div class="grupo-plano" data-plan="ind_apto">
        <button type="button" class="tipo" onclick="toggleTipo('ind_apto')"><small>IND - APARTAMENTO</small></button>
        <div class="opcoes">
          <button type="button" class="opcao disabled" data-plan="ind_apto" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
          <button type="button" class="opcao disabled" data-plan="ind_apto" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
        </div>
      </div>

      <div class="grupo-plano" data-plan="ss_enf">
        <button type="button" class="tipo" onclick="toggleTipo('ss_enf')"><small>SS - ENFERMARIA</small></button>
        <div class="opcoes">
          <button type="button" class="opcao disabled" data-plan="ss_enf" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
          <button type="button" class="opcao disabled" data-plan="ss_enf" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
        </div>
      </div>

      <div class="grupo-plano" data-plan="ss_amb">
        <button type="button" class="tipo" onclick="toggleTipo('ss_amb')"><small>SS - AMBULATORIAL</small></button>
        <div class="opcoes">
          <button type="button" class="opcao disabled" data-plan="ss_amb" data-modo="parcial" onclick="toggleModo(this)">PARCIAL</button>
          <button type="button" class="opcao disabled" data-plan="ss_amb" data-modo="total" onclick="toggleModo(this)">TOTAL</button>
        </div>
      </div>
    </div>

    <div class="idades">
      <textarea id="idades" placeholder="Digite as idades separadas por vírgula. Ex: 23, 35, 62"></textarea>
    </div>

    <div class="linha-opcoes" id="opcoesExtras"></div>

    <button type="button" class="calcular" onclick="calcular()">Calcular Orçamento</button>
    <div id="ancoraResultado"></div>

    <!-- AJUDA PASSO A PASSO -->
    <div id="ajudaPasso" class="ajuda-passo">
      <div class="ajuda-titulo">Não sabe como cotar?</div>
      <div class="ajuda-linha">1️⃣ Selecione o <b>tipo de plano</b></div>
      <div class="ajuda-linha">2️⃣ Escolha <b>Parcial</b> ou <b>Total</b> (até <b>2 orçamentos</b>)</div>
      <div class="ajuda-linha">3️⃣ Digite as <b>idades</b> (ou marque tabela completa)</div>
      <div class="ajuda-linha">4️⃣ Clique em <b>Calcular</b></div>
      <div class="ajuda-linha">5️⃣ Clique em <b>Compartilhar</b> ou <b>Baixar</b> e pronto ✅</div>
    </div>

    <div id="resultado">
      <div id="areaImagem" class="capture-area">
        <!-- ✅ Logo Hapvida centralizada -->
        <div class="logos">
          <div class="logo-wrap">
            <img id="logoHapvida" class="logo" src="./logo-hapvida.png" alt="Hapvida">
          </div>
        </div>

        <div class="linhaDataGeral" id="linhaDataGeral"></div>
        <div id="orcamentosContainer"></div>
      </div>

      <div style="display:grid; gap:8px; margin-top:10px;">
        <button type="button" class="share" onclick="gerarImagem('share')">Compartilhar Orçamento</button>
        <button type="button" class="share" style="background:#005baa;" onclick="gerarImagem('download')">Baixar Orçamento</button>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL -->
  <div class="modal-overlay" id="modalInfo" onclick="clicouForaModal(event)">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div>COPARTICIPAÇÕES / CARÊNCIA</div>
        <button class="modal-close" type="button" onclick="fecharModalInfo()">✕</button>
      </div>
      <div class="modal-body">
        <button class="btn-modal" type="button" onclick="compartilharInfo('copart')">Compartilhar Coparticipações</button>
        <button class="btn-modal secondary" type="button" onclick="compartilharInfo('carencias')">Compartilhar Carências</button>
        <div class="modal-hint">
          *Se o iPhone não abrir o “compartilhar”, ele vai baixar a imagem. Aí é só enviar pelo WhatsApp pela galeria.
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ ÁREA OFFSCREEN: COPART -->
  <div class="offscreen">
    <div id="areaCopart" class="capture-area">
      <div class="logos">
        <div class="logo-wrap">
          <img class="logo" src="./logo-hapvida.png" alt="Hapvida">
        </div>
      </div>
      <div class="info-title">COPARTICIPAÇÕES — NOSSO PLANO</div>
      <div class="info-sub">Atualizado em <span id="dataCopart"></span></div>

      <div class="info-grid-2">
        <div class="info-card">
          <div class="head">Coparticipação parcial (grupo 1 PF)</div>
          <div class="body">
            <div class="kv"><span>Consulta Eletiva</span><span>Isenta</span></div>
            <div class="kv"><span>Consulta de Urgência</span><span>Isenta</span></div>
            <div class="kv"><span>Exames Simples</span><span>Isenta</span></div>
            <div class="kv"><span>Exames Complexos</span><span>Isenta</span></div>
            <div class="kv"><span>Terapias Neurológicas Especiais</span><span>R$ 78,87</span></div>
            <div class="kv"><span>Terapias</span><span>R$ 24,27</span></div>
          </div>
        </div>

        <div class="info-card">
          <div class="head">Coparticipação total (grupo 1 PF)</div>
          <div class="body">
            <div class="kv"><span>Consulta Eletiva</span><span>R$ 25,42</span></div>
            <div class="kv"><span>Consulta de Urgência</span><span>R$ 43,63</span></div>
            <div class="kv"><span>Exames Simples</span><span>40% (máx R$ 45,79)</span></div>
            <div class="kv"><span>Exames Complexos</span><span>40% (máx R$ 114,48)</span></div>
            <div class="kv"><span>Terapias Neurológicas Especiais</span><span>R$ 78,87</span></div>
            <div class="kv"><span>Terapias</span><span>R$ 24,27</span></div>
          </div>
        </div>
      </div>

      <div class="rodape-info">
        *Valores conforme material enviado. Se você quiser, eu coloco um rodapé padrão “sujeito a alteração” também.
      </div>
    </div>
  </div>

  <!-- ✅ ÁREA OFFSCREEN: CARÊNCIAS -->
  <div class="offscreen">
    <div id="areaCarencias" class="capture-area">
      <div class="logos">
        <div class="logo-wrap">
          <img class="logo" src="./logo-hapvida.png" alt="Hapvida">
        </div>
      </div>
      <div class="info-title">CARÊNCIAS — NOSSO PLANO PF</div>
      <div class="info-sub">Atualizado em <span id="dataCarencias"></span></div>

      <div class="carencias-section">
        <div class="head">24hrs* (urgência/emergência)</div>
        <div class="body">
          casos de urgência/emergência.
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="carencias-section">
        <div class="head">24hrs* (consultas e exames simples)</div>
        <div class="body">
          <ul>
            <li>consultas médicas e exames laboratoriais simples (exceto Imunológicos, Hormônios e PAC)</li>
            <li>Raio-X simples (Radiografia não contrastada)</li>
            <li>Eletrocardiograma (ECG)</li>
          </ul>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="carencias-section">
        <div class="head">90 dias*</div>
        <div class="body">
          <ul>
            <li>Exames cardiológicos: Teste Ergométrico, Holter, Ecocardiograma (Convencional)</li>
            <li>Oftalmológicos: Curva Tensional, Tonometria, Campimetria, Mapeamento de Retina</li>
            <li>Otorrinolaringológicos: Audiometrias e Impedanciometrias, Pesquisa de Potencial Evocado (BERA)</li>
            <li>exceto os considerados de Alta Complexidade (PAC)</li>
            <li>Raio-X Contrastado</li>
            <li>Ultrassonografias (exceto endoscópicas)</li>
            <li>Mamografia Convencional</li>
            <li>Densitometria Óssea</li>
          </ul>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="carencias-section">
        <div class="head">180 dias*</div>
        <div class="body">
          Para os seguintes procedimentos, desde que não estejam relacionados às patologia(s) para a(s) qual(is) o beneficiário cumpre CPT – Cobertura Parcial Temporária:
          <ul>
            <li>Cirurgias Ambulatoriais</li>
            <li>Procedimentos de Alta Complexidade (PAC), como: Tomografia Computadorizada, Ressonância Magnética, Endoscopias, Colonoscopia</li>
            <li>Medicina Nuclear</li>
            <li>Angiografia (cerebral central e/ou periférica)</li>
            <li>procedimentos que necessitem de Hemodinâmica (ex.: Cateterismo Cardíaco)</li>
            <li>Radioterapia e Quimioterapia</li>
            <li>Consultas, Sessões e Terapias Simples, Especiais, Isoladas e Multidisciplinares, inclusive com métodos específicos — ABA, BOBATH e outras (ex.: psicoterapia, fonoaudiologia, nutricionista, fisioterapia, terapia ocupacional) — para todos os procedimentos não mencionados nos itens anteriores.</li>
          </ul>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="carencias-section">
        <div class="head">300 dias*</div>
        <div class="body">
          Partos a termo (somente para planos com segmentação HOSPITALAR COM OBSTETRÍCIA)
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="carencias-section">
        <div class="head">720 dias*</div>
        <div class="body">
          Cobertura de doenças ou lesões pré-existentes.
        </div>
      </div>

      <div class="rodape-info">
        *Estas carências correspondem ao plano Nosso Plano PF. Elas podem variar de acordo com o plano apresentado.
        O consultor lhe passará o material de carência para o plano que for necessário.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const LIMITE_ORCAMENTOS = 2;
    const ODONTO_POR_VIDA = 23.25;

    const tiposAtivos = new Set();
    let selecionados = [];

    /* ===== Caixa de Novidades ===== */
    // mudou pra v3 pra reaparecer pra todos após atualizar
    const NOVIDADES_STORAGE_KEY = "hapvida_novidades_fechadas_v3";

    function mostrarNovidades(){
      const box = document.getElementById("novidadesBox");
      if(!box) return;

      const fechado = localStorage.getItem(NOVIDADES_STORAGE_KEY) === "1";
      box.style.display = fechado ? "none" : "block";
    }

    function fecharNovidades(){
      const box = document.getElementById("novidadesBox");
      if(box) box.style.display = "none";
      try{ localStorage.setItem(NOVIDADES_STORAGE_KEY, "1"); }catch(e){}
    }

    /* ====== ✅ Fallback da logo (resolve “nomezinho”) ====== */
    function tentarCarregarLogo(){
      const img = document.getElementById("logoHapvida");
      if(!img) return;

      const candidatos = [
        "./logo-hapvida.png",
        "logo-hapvida.png",
        "./hapvida.png",
        "hapvida.png",
        "./img/hapvida.png",
        "img/hapvida.png",
        "./images/hapvida.png",
        "images/hapvida.png"
      ];

      const testar = (src) => new Promise((resolve) => {
        const t = new Image();
        t.onload = () => resolve({ ok:true, src });
        t.onerror = () => resolve({ ok:false, src });
        t.src = src + (src.includes("?") ? "" : ("?v=" + Date.now())); // evita cache antigo
      });

      (async () => {
        for(const src of candidatos){
          const r = await testar(src);
          if(r.ok){
            img.src = src; // coloca o caminho limpo
            return;
          }
        }
      })();
    }

    const nomesClienteBase = {
      ind_enf: "NOSSO PLANO ENFERMARIA COPARTICIPAÇÃO",
      ind_amb: "NOSSO PLANO AMBULATORIAL COPARTICIPAÇÃO",
      ind_apto:"NOSSO PLANO APARTAMENTO COPARTICIPAÇÃO",
      ss_enf:  "SUPER SIMPLES ENFERMARIA COPARTICIPAÇÃO",
      ss_amb:  "SUPER SIMPLES AMBULATORIAL COPARTICIPAÇÃO"
    };

    function isSuperSimples(tipo){
      return typeof tipo === "string" && tipo.startsWith("ss_");
    }

    function nomeClienteCompletoHTML(tipo, modo){
      let base = nomesClienteBase[tipo] || "";
      if(isSuperSimples(tipo)){
        base = base.replace(/^SUPER SIMPLES /, "PLANO EMPRESARIAL ");
      }
      const mod = (modo || "").toUpperCase();
      if(mod === "TOTAL"){
        return `${base} <span class="total-red">TOTAL</span>`;
      }
      return `${base} ${mod}`.trim();
    }

    function dataHojeBR(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function esconderAjuda(){
      const ajuda = document.getElementById("ajudaPasso");
      if(ajuda) ajuda.style.display = "none";
    }
    function mostrarAjuda(){
      const ajuda = document.getElementById("ajudaPasso");
      if(ajuda) ajuda.style.display = "block";
    }

    function formatarBR(valor){
      return Number(valor).toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    /* ====== TABELAS ====== */
    const tabelas = {
      ind_enf_parcial: [
        ["00 a 18",0,18,241.68,205.43],["19 a 23",19,23,311.18,264.50],["24 a 28",24,28,354.18,301.05],
        ["29 a 33",29,33,393.74,334.68],["34 a 38",34,38,412.20,350.37],["39 a 43",39,43,462.60,393.21],
        ["44 a 48",44,48,558.98,475.13],["49 a 53",49,53,762.08,647.77],["54 a 58",54,58,1020.23,867.20],
        ["59+",59,200,1318.95,1121.11]
      ],
      ind_enf_total: [
        ["00 a 18",0,18,198.23,168.50],["19 a 23",19,23,253.82,215.75],["24 a 28",24,28,288.22,244.99],
        ["29 a 33",29,33,319.87,271.89],["34 a 38",34,38,334.64,284.44],["39 a 43",39,43,374.96,318.72],
        ["44 a 48",44,48,452.06,384.25],["49 a 53",49,53,614.53,522.35],["54 a 58",54,58,821.04,697.88],
        ["59+",59,200,1060.00,901.00]
      ],
      ind_amb_parcial: [
        ["00 a 18",0,18,202.80,172.38],["19 a 23",19,23,267.06,227.00],["24 a 28",24,28,304.44,258.77],
        ["29 a 33",29,33,339.61,288.67],["34 a 38",34,38,357.41,303.80],["39 a 43",39,43,401.25,341.06],
        ["44 a 48",44,48,490.67,417.07],["49 a 53",49,53,680.53,578.45],["54 a 58",54,58,917.37,779.76],
        ["59+",59,200,1191.43,1012.72]
      ],
      ind_amb_total: [
        ["00 a 18",0,18,130.22,110.69],["19 a 23",19,23,171.04,145.38],["24 a 28",24,28,194.78,165.56],
        ["29 a 33",29,33,217.12,184.55],["34 a 38",34,38,228.42,194.16],["39 a 43",39,43,256.27,217.83],
        ["44 a 48",44,48,313.06,266.10],["49 a 53",49,53,433.65,368.60],["54 a 58",54,58,584.08,496.47],
        ["59+",59,200,758.15,644.43]
      ],
      ind_apto_parcial: [
        ["00 a 18",0,18,350.27,297.73],["19 a 23",19,23,454.52,386.34],["24 a 28",24,28,519.02,441.17],
        ["29 a 33",29,33,578.36,491.61],["34 a 38",34,38,606.05,515.14],["39 a 43",39,43,681.65,579.40],
        ["44 a 48",44,48,826.22,702.29],["49 a 53",49,53,1130.87,961.24],["54 a 58",54,58,1518.10,1290.39],
        ["59+",59,200,1966.18,1671.25]
      ],
      ind_apto_total: [
        ["00 a 18",0,18,285.10,242.34],["19 a 23",19,23,368.49,313.22],["24 a 28",24,28,420.09,357.08],
        ["29 a 33",29,33,467.56,397.43],["34 a 38",34,38,489.71,416.25],["39 a 43",39,43,550.19,467.66],
        ["44 a 48",44,48,665.84,565.96],["49 a 53",49,53,909.55,773.12],["54 a 58",54,58,1219.32,1036.42],
        ["59+",59,200,1577.77,1341.10]
      ],
      ss_enf_parcial: [
        ["00 a 18",0,18,187.76,159.60],["19 a 23",19,23,210.29,178.75],["24 a 28",24,28,235.52,200.19],
        ["29 a 33",29,33,270.85,230.22],["34 a 38",34,38,311.48,264.76],["39 a 43",39,43,370.66,315.06],
        ["44 a 48",44,48,463.33,393.83],["49 a 53",49,53,579.16,492.29],["54 a 58",54,58,984.57,836.88],
        ["59+",59,200,1102.72,937.31]
      ],
      ss_enf_total: [
        ["00 a 18",0,18,146.72,124.71],["19 a 23",19,23,164.33,139.68],["24 a 28",24,28,184.05,156.44],
        ["29 a 33",29,33,211.66,179.91],["34 a 38",34,38,243.41,206.90],["39 a 43",39,43,289.66,246.21],
        ["44 a 48",44,48,362.08,307.77],["49 a 53",49,53,452.60,384.71],["54 a 58",54,58,769.42,654.01],
        ["59+",59,200,861.75,732.49]
      ],
      ss_amb_parcial: [
        ["00 a 18",0,18,139.18,118.30],["19 a 23",19,23,155.88,132.50],["24 a 28",24,28,174.59,148.40],
        ["29 a 33",29,33,200.78,170.66],["34 a 38",34,38,230.90,196.27],["39 a 43",39,43,274.77,233.55],
        ["44 a 48",44,48,343.46,291.94],["49 a 53",49,53,429.33,364.93],["54 a 58",54,58,729.86,620.38],
        ["59+",59,200,817.44,694.82]
      ],
      ss_amb_total: [
        ["00 a 18",0,18,102.77,87.35],["19 a 23",19,23,115.10,97.84],["24 a 28",24,28,128.91,109.57],
        ["29 a 33",29,33,148.25,126.01],["34 a 38",34,38,170.49,144.92],["39 a 43",39,43,202.88,172.45],
        ["44 a 48",44,48,253.60,215.56],["49 a 53",49,53,317.00,269.45],["54 a 58",54,58,538.90,458.07],
        ["59+",59,200,603.57,513.03]
      ]
    };

    let toastTimer = null;
    function showToast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.classList.remove("show"), 1600);
    }

    function limparResultado(){
      document.getElementById("resultado").style.display = "none";
      document.getElementById("orcamentosContainer").innerHTML = "";
      mostrarAjuda();
    }

    function atualizarCheckboxes(){
      const temIND = selecionados.some(s => !isSuperSimples(s.tipo));
      const temSS  = selecionados.some(s => isSuperSimples(s.tipo));

      const container = document.getElementById("opcoesExtras");
      container.innerHTML = "";

      if(!temIND && !temSS) return;

      container.insertAdjacentHTML("beforeend", `
        <label class="opt-label">
          <input type="checkbox" id="tabelaCompleta" />
          Tabela completa (por faixa etária - sem idades)
        </label>
      `);

      if(temIND){
        container.insertAdjacentHTML("beforeend", `
          <label class="opt-label">
            <input type="checkbox" id="familiar1grau" />
            Familiar 1º grau (5% sobre o valor)
          </label>
        `);
      }
      if(temSS){
        container.insertAdjacentHTML("beforeend", `
          <label class="opt-label">
            <input type="checkbox" id="odontoSS" />
            Odonto (somar R$ ${formatarBR(ODONTO_POR_VIDA)} por beneficiário)
          </label>
        `);
      }
    }

    function atualizarOpcoesAtivas(){
      document.querySelectorAll(".grupo-plano").forEach(grupo=>{
        const plan = grupo.dataset.plan;
        const tipoBtn = grupo.querySelector(".tipo");
        const ativo = tiposAtivos.has(plan);

        if(ativo) tipoBtn.classList.add("ativo");
        else tipoBtn.classList.remove("ativo");

        grupo.querySelectorAll(".opcao").forEach(op=>{
          if(ativo) op.classList.remove("disabled");
          else{
            op.classList.add("disabled");
            op.classList.remove("ativo");
          }
        });
      });

      document.querySelectorAll(".opcao").forEach(op=>{
        const tipo = op.dataset.plan;
        const modo = op.dataset.modo;
        const selected = selecionados.some(s => s.tipo===tipo && s.modo===modo);
        if(selected) op.classList.add("ativo");
        else op.classList.remove("ativo");
      });

      atualizarCheckboxes();
    }

    function toggleTipo(planKey){
      if(tiposAtivos.has(planKey)){
        tiposAtivos.delete(planKey);
        selecionados = selecionados.filter(s => s.tipo !== planKey);
        limparResultado();
        atualizarOpcoesAtivas();
        return;
      }
      tiposAtivos.add(planKey);
      limparResultado();
      atualizarOpcoesAtivas();
    }

    function toggleModo(btn){
      const tipo = btn.dataset.plan;
      const modo = btn.dataset.modo;

      if(!tiposAtivos.has(tipo) || btn.classList.contains("disabled")) return;

      const idx = selecionados.findIndex(s => s.tipo===tipo && s.modo===modo);

      if(idx >= 0){
        selecionados.splice(idx, 1);
        limparResultado();
        atualizarOpcoesAtivas();
        return;
      }

      if(selecionados.length >= LIMITE_ORCAMENTOS){
        showToast("Máximo de 2 orçamentos por vez.");
        return;
      }

      selecionados.push({ tipo, modo });
      limparResultado();
      atualizarOpcoesAtivas();
    }

    function parseIdades(){
      return document.getElementById("idades").value
        .split(",")
        .map(s => parseInt(s.trim(), 10))
        .filter(n => Number.isFinite(n));
    }

    function taxaAdesaoTexto(tipo, vidas){
      if(isSuperSimples(tipo)){
        return `Taxa de adesão: R$ 20,00 por beneficiário (R$ ${formatarBR(20*vidas)})`;
      }
      return `Taxa de adesão: R$ 35,00 por contrato`;
    }

    function colgroupHTML({ completa=false }){
      if(completa){
        return `
          <colgroup>
            <col style="width:46%;">
            <col style="width:27%;">
            <col style="width:27%;">
          </colgroup>
        `;
      }

      return `
        <colgroup>
          <col style="width:32%;">
          <col style="width:14%;">
          <col style="width:27%;">
          <col style="width:27%;">
        </colgroup>
      `;
    }

    function cabecalhoTabelaHTML({ completa=false, familiar=false }){
      const col3 = familiar ? "5%<br>Familiar" : "VALOR<br>Normal";
      return `
        <tr class="cab">
          <th>Faixa<br>Etária</th>
          ${completa ? "" : "<th>Idade</th>"}
          <th>${col3}</th>
          <th>15%<br>(3 meses)</th>
        </tr>
      `;
    }

    function blurActive(){
      if (document.activeElement) document.activeElement.blur();
    }

    function corTabelaCompletaPorIndice(i){
      const n = (i % 6) + 1;
      return `tblc-${n}`;
    }

    function calcular(){
      blurActive();

      if(selecionados.length === 0){
        alert("Selecione até 2 orçamentos (tipo + parcial/total).");
        return;
      }

      esconderAjuda();

      const tabelaCompletaEl = document.getElementById("tabelaCompleta");
      const completa = tabelaCompletaEl ? tabelaCompletaEl.checked : false;

      const idades = completa ? [] : parseIdades();

      if(!completa && idades.length === 0){
        alert("Informe ao menos uma idade (ex: 23, 35, 62) ou marque 'Tabela completa'.");
        return;
      }

      if (typeof gtag === "function") {
        gtag("event", "orcamento_calculado", {
          orcamentos_qtd: selecionados.length,
          modo_tabela: completa ? "completa" : "idades",
          promo_15: 1
        });
      }

      const familiarEl = document.getElementById("familiar1grau");
      const odontoEl   = document.getElementById("odontoSS");

      const familiarAtivo = (familiarEl) ? familiarEl.checked : false;
      const odontoAtivo   = odontoEl ? odontoEl.checked : false;

      const cont = document.getElementById("orcamentosContainer");
      cont.innerHTML = "";

      document.getElementById("linhaDataGeral").textContent = `Orçamento dia ${dataHojeBR()}`;
      document.getElementById("resultado").style.display = "block";

      selecionados.forEach((sel, idx)=>{
        const chave = `${sel.tipo}_${sel.modo}`;
        const lista = tabelas[chave];
        if(!lista){
          alert("Tabela não encontrada para um dos planos selecionados.");
          return;
        }

        const isSS = isSuperSimples(sel.tipo);
        const aplicarOdonto   = (isSS) && odontoAtivo;
        const aplicarFamiliar = (!isSS) && familiarAtivo;

        let totalNormal = 0;
        let total15 = 0;
        let total5 = 0;

        let rowsHTML = "";

        if(completa){
          lista.forEach(faixa=>{
            let vN = Number(faixa[3]) || 0;
            let v15 = Number(faixa[4]) || 0;

            if(aplicarOdonto){
              vN += ODONTO_POR_VIDA;
              v15 += ODONTO_POR_VIDA;
            }

            const v5 = vN * 0.95;

            rowsHTML += `
              <tr>
                <td>${faixa[0]}</td>
                <td>R$ ${formatarBR(aplicarFamiliar ? v5 : vN)}</td>
                <td>R$ ${formatarBR(v15)}</td>
              </tr>
            `;
          });
        } else {
          idades.forEach(idade=>{
            const faixa = lista.find(f => idade >= f[1] && idade <= f[2]);
            if(!faixa) return;

            let vN = Number(faixa[3]) || 0;
            let v15 = Number(faixa[4]) || 0;

            if(aplicarOdonto){
              vN += ODONTO_POR_VIDA;
              v15 += ODONTO_POR_VIDA;
            }

            const v5 = vN * 0.95;

            totalNormal += vN;
            total15 += v15;
            total5 += v5;

            rowsHTML += `
              <tr>
                <td>${faixa[0]}</td>
                <td>${idade}</td>
                <td>R$ ${formatarBR(aplicarFamiliar ? v5 : vN)}</td>
                <td>R$ ${formatarBR(v15)}</td>
              </tr>
            `;
          });
        }

        let totalHTML = "";
        if(!completa){
          if(aplicarFamiliar){
            totalHTML = `
              <div class="totais">
                <div>Total 5% Familiar: R$ ${formatarBR(total5)}</div>
                <div>Total 15% (3 meses): R$ ${formatarBR(total15)}</div>
              </div>
            `;
          } else {
            totalHTML = `
              <div class="totais">
                <div>Total normal: R$ ${formatarBR(totalNormal)}</div>
                <div>Total 15% (3 meses): R$ ${formatarBR(total15)}</div>
              </div>
            `;
          }
        }

        let odontoInfo = "";
        if(aplicarOdonto){
          if(completa){
            odontoInfo = `<div class="odonto-info">Odonto: R$ ${formatarBR(ODONTO_POR_VIDA)} por beneficiário — incluído no valor</div>`;
          } else {
            const totalOdonto = ODONTO_POR_VIDA * idades.length;
            odontoInfo = `<div class="odonto-info">Odonto: R$ ${formatarBR(ODONTO_POR_VIDA)} por beneficiário (R$ ${formatarBR(totalOdonto)}) — incluído nos valores</div>`;
          }
        }

        let familiarInfo = "";
        if(aplicarFamiliar){
          familiarInfo = `<div class="familiar-info">*Aplicado desconto de 5% para familiar de 1º grau</div>`;
        }

        let ssAviso = "";
        if(isSS){
          ssAviso = `<div class="ss-aviso">Condição empresarial: a partir de 2 vidas</div>`;
        }

        const nomeDentroTabelaHTML = nomeClienteCompletoHTML(sel.tipo, sel.modo);
        const taxa = completa ? "" : taxaAdesaoTexto(sel.tipo, idades.length);

        const classeCompleta = completa ? `tabela-completa ${corTabelaCompletaPorIndice(idx)}` : "";
        const colCount = completa ? 3 : 4;

        cont.insertAdjacentHTML("beforeend", `
          <div class="orcamento ${classeCompleta}">
            <div class="tabela-wrap">
              <table class="tabela-precos">
                ${colgroupHTML({ completa })}
                <thead>
                  <tr class="titulo-tabela">
                    <th colspan="${colCount}">${nomeDentroTabelaHTML}</th>
                  </tr>
                  ${cabecalhoTabelaHTML({ completa, familiar: aplicarFamiliar })}
                </thead>
                <tbody>
                  ${rowsHTML}
                </tbody>
              </table>
            </div>

            ${ssAviso}
            ${completa ? "" : `<div class="taxa-adesao">${taxa}</div>`}
            ${totalHTML}
            ${odontoInfo}
            ${familiarInfo}
          </div>
        `);
      });

      setTimeout(() => {
        document.getElementById("ancoraResultado").scrollIntoView({
          behavior: "smooth",
          block: "start"
        });
      }, 200);
    }

    async function gerarImagem(modo = "share"){
      const area = document.getElementById("areaImagem");

      document.body.classList.add("capturando");
      await new Promise(r => requestAnimationFrame(() => r()));

      const canvas = await html2canvas(area, {
        backgroundColor: "#ffffff",
        useCORS: true,
        scale: 3
      });

      document.body.classList.remove("capturando");

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      if(!blob){
        alert("Não foi possível gerar a imagem. Tente novamente.");
        return;
      }

      const file = new File([blob], "orcamento_hapvida.png", { type:"image/png" });

      if(modo === "share"){
        const podeCompartilhar =
          navigator.share &&
          (!navigator.canShare || navigator.canShare({ files:[file] }));

        if(podeCompartilhar){
          try{
            await navigator.share({ title: "Orçamento", files: [file] });
            return;
          } catch(e){
            return;
          }
        }

        alert("No seu iPhone, o compartilhamento não ficou disponível. Use 'Baixar Orçamento' e compartilhe pela galeria.");
        return;
      }

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "orcamento_hapvida.png";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    /* ====== ✅ MODAL INFO ====== */
    function abrirModalInfo(){
      const m = document.getElementById("modalInfo");
      if(m) m.style.display = "flex";

      // atualiza datas nas imagens
      const hoje = dataHojeBR();
      const d1 = document.getElementById("dataCopart");
      const d2 = document.getElementById("dataCarencias");
      if(d1) d1.textContent = hoje;
      if(d2) d2.textContent = hoje;
    }

    function fecharModalInfo(){
      const m = document.getElementById("modalInfo");
      if(m) m.style.display = "none";
    }

    function clicouForaModal(e){
      if(e.target && e.target.id === "modalInfo"){
        fecharModalInfo();
      }
    }

    async function compartilharInfo(tipo){
      fecharModalInfo();

      const alvoId = (tipo === "copart") ? "areaCopart" : "areaCarencias";
      const nome = (tipo === "copart") ? "coparticipacoes_hapvida.png" : "carencias_hapvida.png";

      await gerarImagemDeElemento(alvoId, nome);
    }

    async function gerarImagemDeElemento(elementId, fileName){
      const area = document.getElementById(elementId);
      if(!area){
        alert("Área não encontrada para gerar imagem.");
        return;
      }

      document.body.classList.add("capturando");
      await new Promise(r => requestAnimationFrame(() => r()));

      const canvas = await html2canvas(area, {
        backgroundColor: "#ffffff",
        useCORS: true,
        scale: 3
      });

      document.body.classList.remove("capturando");

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      if(!blob){
        alert("Não foi possível gerar a imagem. Tente novamente.");
        return;
      }

      const file = new File([blob], fileName, { type:"image/png" });

      const podeCompartilhar =
        navigator.share &&
        (!navigator.canShare || navigator.canShare({ files:[file] }));

      if(podeCompartilhar){
        try{
          await navigator.share({ title: "Hapvida", files: [file] });
          return;
        } catch(e){
          return;
        }
      }

      // fallback: baixa
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(a.href);

      alert("Se não apareceu o compartilhar, a imagem foi baixada. Envie pelo WhatsApp pela galeria.");
    }

    // inicia estado
    atualizarOpcoesAtivas();
    mostrarNovidades();

    // ✅ tenta resolver a logo automaticamente
    tentarCarregarLogo();
  </script>
</body>
</html>
